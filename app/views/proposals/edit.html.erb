<% @page_title = @proposal.title %>
<h1>Modifica la proposta</h1>

<%= form_for @group ? [@group, @proposal] : @proposal, :validate => true, :remote => @remote do |f| %>

    <h4>Descrivi in maniera esaustiva le problematiche che vuoi affrontare e quali sono gli obiettivi che vuole
      raggiungere la proposta</h4>

    <p>
      <%= f.label :proposal_category_id %><br/>
      <%= select("proposal", "proposal_category_id", ProposalCategory.all.collect { |p| [p.description, p.id] }) %>
    </p>

    <% @proposal.sections.each do |section| %>
        <%= f.fields_for :sections, section do |s| %>
            <%= s.hidden_field :title %>
            <%= s.hidden_field :seq %>
            <%= s.fields_for :paragraphs, section.paragraphs.first do |p| %>
                <p>
                  <%= p.label :content_dirty, section.title %><br/>
                  <%= p.text_area :content_dirty, :rows => 5, :style => "width:98%;height:280px;", :class => "tinymce" %>
                  <%= p.hidden_field :content %>
                  <%= p.hidden_field :seq %>
                </p>
            <% end %>
        <% end %>
    <% end %>

    <h4>Modifica e aggiorna il testo della proposta!</h4>

    <% @proposal.solutions.each do |solution| %>
        <%= f.fields_for :solutions, @solution do |sol| %>
            <%= sol.hidden_field :seq %>
            <% solution.sections.each do |section| %>
                <%= sol.fields_for :sections, section do |s| %>
                    <%= s.hidden_field :title %>
                    <%= s.hidden_field :seq %>
                    <%= s.fields_for :paragraphs, section.paragraphs.first do |p| %>
                        <p>
                          <%= p.label :content_dirty, section.title %><br/>
                          <%= p.text_area :content_dirty, :rows => 5, :style => "width:98%;height:280px;", :class => "tinymce" %>
                          <%= p.hidden_field :content %>
                          <%= p.hidden_field :seq %>
                        </p>
                    <% end %>
                <% end %>
            <% end %>
        <% end %>
    <% end %>

    <p>
      <%= render :partial => 'fragments/error_messages', :locals => {:resource => @proposal} %>
      <%= f.submit "Aggiorna", :class => 'buttonStyle', :onclick => 'return fillCleanFields();' %>
    </p>
<% end %>


<script type="text/javascript">
    tinyMCE.init({
        mode: 'textareas',
        theme: 'advanced',
        theme_advanced_toolbar_location: 'top',
        theme_advanced_toolbar_align: 'left',
        theme_advanced_buttons1: 'bold,italic,underline,separator,undo,redo,separator,bullist,numlist,separator,link,unlink,anchor,image,youtube,separator,ice_toggleshowchanges',
        theme_advanced_buttons2: '',
        theme_advanced_buttons3: '',
        plugins: 'media,inlinepopups,youtube,ice',
        theme_advanced_statusbar_location: "none",
        valid_elements: "-p",
        cleanup_on_startup: true,
        ice: {
            user: { name: '<%=current_user.fullname%>', id: <%=current_user.id%>},
            preserveOnPaste: 'p,a[href],i,em,strong'
        },
        body_class: "CT-hide"
    });
    function fillCleanFields() {
        <%for i in 0..(@proposal.sections.count-1) %>
        $('#proposal_sections_attributes_<%=i%>_paragraphs_attributes_0_content').val(tinymce.get('proposal_sections_attributes_<%=i%>_paragraphs_attributes_0_content_dirty').execCommand('icecleanbody'));
        <%end%>
        <%for i in 0..(@proposal.solutions.count-1) %>
        <%for j in 0..(@proposal.solutions[i].sections.count-1) %>
        $('#proposal_solutions_attributes_<%=i%>_sections_attributes_<%=j%>_paragraphs_attributes_0_content').val(tinymce.get('proposal_solutions_attributes_<%=i%>_sections_attributes_<%=j%>_paragraphs_attributes_0_content_dirty').execCommand('icecleanbody'));
        <%end%>
        <%end%>
        return true;
    }
</script>