<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-US">
	<head>
		<title><%= @page_title || 'Democracy Online (Airesis) - '+ VERSION.to_s + ' Beta'%></title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
		
		<%= stylesheet_link_tag 'application' %>
		<%= javascript_include_tag 'application' %>
		<%= stylesheet_link_tag 'redmond/custom'%> 
		<%= csrf_meta_tag %>
		<%= yield :head %>
		
		<link rel="shortcut icon" href="/favicon.ico" />
	</head>
	<body>
		<!-- ### facebook ###-->
		<div id="fb-root"></div>
		<script>
			( function(d, s, id) {
				var js, fjs = d.getElementsByTagName(s)[0];
				if(d.getElementById(id)) {
					return;
				}
				js = d.createElement(s);
				js.id = id;
				<%if (Rails.env == "production")%>
				js.src = "//connect.facebook.net/it_IT/all.js#xfbml=1&appId=242345195791486";
				<%else%>
				js.src = "//connect.facebook.net/it_IT/all.js#xfbml=1&appId=221145254619152";
				<%end%>
				fjs.parentNode.insertBefore(js, fjs);
			}(document, 'script', 'facebook-jssdk'));

		</script>
		
		<script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>
		
		<!-- ##### Header ##### -->
		<div id="header">
			<div id="fixed">
				<div class="midHeader">
					<h2 class="headerTitle" lang="la"><%=link_to "Airesis", root_path%></h2>
				</div>
				<div class="subHeader">
					<span class="doNotDisplay">Navigation:</span>
					<%= link_to 'Le proposte', proposals_path, :class => 'buttonStyle' %>
					| <%= link_to 'I blog', blogs_path %>
					| <%= link_to 'I gruppi', groups_path %>
					| <%= link_to 'Calendario', events_path %>
					<% if user_signed_in? %>
					| <%= link_to 'Notifiche', '#', :id => 'notifications_place' %>
					<%end%>
				</div>
				<div class="superHeader">
					<% if user_signed_in? %> <span>Benvenuto </span>
						<%if current_user.name%>
						<%= current_user.name %>
						<%else%>
						<%= current_user.login %>
						<%end%>
						
					<% else %> 
					<span><%= t('pages.top_panel.login') %></span>
					<% end %>
				</div>
				<% if user_signed_in? %> 
					<div class="user-panel shadow-box" id="user-panel">
							<div style="float:left">
								<%= current_user.user_image_tag%>
							</div>
							<ul class="menu-list">
								<li>
									<span class="Mo ui-icon ui-icon-comment"></span>
									<% if current_user.blog %>
									<%= link_to 'Il mio blog', current_user.blog %>
									<% else %>
									<%= link_to 'Crea un tuo blog', new_blog_path %>
									<% end %>
									<li>
										<span class="Mo ui-icon ui-icon-contact"></span>
										<%= link_to 'La mia pagina', user_url(current_user.id) %>
									</li>
									<% if is_admin?%>
									<li>
										<span class="Mo ui-icon ui-icon-key"></span>
										<%= link_to 'Amministrazione', admin_panel_path%>
									</li>
									<%end%>
								</li>
								<li>
									<span class="Mo ui-icon ui-icon-power"></span>
									<%= link_to 'Logout', destroy_user_session_path, :method => 'delete' %>
								</li>
							</ul>
						</div>
						
						
						
						<div class="notification-panel shadow-box" id="notification-panel">
							<ul class="menu-list">
								<li>
								Nessuna notifica
								</li>
							</ul>
						</div>
				<% else %>
					<div class="shadow-box" id="registration-panel">
							
						<%= form_for(resource, :as => resource_name, :url => {:action => "create", :controller => "devise/sessions"}) do |f| %>
						  <div><%= f.label :login %><br />
						  <%= f.text_field :login %></div>
						  
						  <div><%= f.label :password %><br />
						  <%= f.password_field :password %></div>
						
						  <% if devise_mapping.rememberable? -%>
						    <div><%= f.check_box :remember_me %> <%= f.label :remember_me, "Ricordami su questo computer" %></div>
						  <% end -%>
						
						  <div><%= f.submit "Login" %></div>
						<% end %>
						
						<%= render :partial => "devise/shared/links" %>
						</div>
				
				<% end %>
				
				<div style="clear: both; height: 0; overflow: hidden;"></div>
			</div>
			<span>
				<div id = 'loading'>
					Caricamento...
				</div> </span>
		</div>
		<!-- ##### Main Copy ##### -->
		<div id="main-copy">
			<div id="leftpanel">
				<%= yield :left_panel%>
			</div>
			<div id="centerpanelextended">
				<div id="flash_messages" style="height:20px">
					<%= render :partial => 'layouts/flash', :locals => {:flash => flash} %>
				</div>
				<%= yield :layout %>
			</div>			
			<div style="clear: both; height: 0; overflow: hidden;"></div>
		</div>
		<script type="text/javascript">
			$('input:submit,input:button, .subHeader a').button();
			
			
			<%if user_signed_in?%>
				$('#user-panel').hide();
				user_panel_shown = false;
				$('html').click(function() {
					if(user_panel_shown) {
						$('#user-panel').hide();
						$('.superHeader').removeClass('active');
						user_panel_shown = false;
					}
				});
				$('.superHeader').click(function(event) {
					if(user_panel_shown) {
						$('#user-panel').hide();
						$('.superHeader').removeClass('active');
						user_panel_shown = false;
					} else {
						$('#user-panel').show('drop',{ direction: "up" })
						$('.superHeader').addClass('active');
						user_panel_shown = true;
					}
					event.stopPropagation();
				});
				
				$(".superHeader").mouseover(function(){
			    	$(this).addClass("active");
			    }).mouseout(function(){
			    	
			    	if (user_panel_shown == false) {
		    			$(this).removeClass("active");
		    		}		
			    			
			    });
	
				$('#user-panel').click(function(event) {
					event.stopPropagation();
				});
				
				
				function fetchNotifications(){
				    jQuery.ajax({
				        data: '',
				        dataType: 'script',
				        type: 'get',
				        url: "/alerts/polling"
				    });
				}
				
				function poll(){
				    $.getScript("/alerts/polling/")
				    setTimeout(poll,60000);	//valore temporaneo
				};
				
				poll();
				
				$('#notification-panel').hide();
				notification_panel_shown = false;
				$('html').click(function() {
					if(notification_panel_shown) {
						$('#notification-panel').hide();						
						notification_panel_shown = false;
					}
				});
				$('#notifications_place').click(function(event) {
					if(notification_panel_shown) {
						$('#notification-panel').hide();						
						notification_panel_shown = false;
					} else {
						$('#notification-panel').show('drop',{ direction: "up" })
						notification_panel_shown = true;
					}
					event.stopPropagation();
				});
	
				$('#notification-panel').click(function(event) {
					event.stopPropagation();
				});
			<%else%>	
				$('#registration-panel').hide();
				user_panel_shown = false;
				$('html').click(function() {
					if(user_panel_shown) {
						$('#registration-panel').hide();
						$('.superHeader').removeClass('active');
						user_panel_shown = false;
					}
				});
				$('.superHeader').click(function(event) {
					if(user_panel_shown) {
						$('#registration-panel').hide();
						$('.superHeader').removeClass('active');
						user_panel_shown = false;
					} else {
						$('#registration-panel').show('drop',{ direction: "up" })
						$('.superHeader').addClass('active');
						user_panel_shown = true;
					}
					event.stopPropagation();
				});
	
				$('#registration-panel').click(function(event) {
					event.stopPropagation();
				});
			<%end%>
			$('#loading').hide();

		</script>
	</body>
</html>
